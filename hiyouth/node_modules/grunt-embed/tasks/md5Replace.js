/**
 * Created with JetBrains PhpStorm.
 * User: dreamzhu
 * Date: 15-1-4
 * Time: 下午7:19
 * To change this template use File | Settings | File Templates.
 */

module.exports = function(grunt) {
	'use strict';

	function appendFileName(file, content){
		var filename = file.split('?'),
			chunk = filename[0].split('.');
		chunk[chunk.length-1] = content+'.'+chunk[chunk.length-1];
		filename[0] = chunk.join('.');
		return filename.join('?');
	}

	function getFileMD5(file){
		var content = grunt.file.read(file, {encoding: 'utf-8'});
		var _encrymd5 = require('crypto').createHash('md5');
		_encrymd5.update(content);
		var md5 = _encrymd5.digest('hex').substr(0,8);
		return md5;
	}

	grunt.registerTask('md5Replace', '', function(param) {

		var config = grunt.config.get('md5Replace');
		//设置默认选项

		if (config.src) {
			var content = grunt.file.read(config.src, {encoding: 'utf-8'});
			content = content.replace(/md5:\{\}/g, function(match) {
				console.log(match);
				var fileList = config.files || [];
				var map = [];
				for (var i = 0; i < fileList.length; i++) {
					var file = config.base + fileList[i];
					var md5 = getFileMD5(file);
					var newfile = appendFileName(config.dest + fileList[i], md5);
					grunt.file.copy(file, newfile);
					map.push("'" + fileList[i].replace('.js', '') + "':'" + md5 + "'" );
					//特殊逻辑
					if (fileList[i] == 'lib/zepto.js') {
						map.push("'zepto':'" + md5 + "'" );
					}
				}
				console.log( match.replace('{}', '{' + map.join(',') +'}'));
				return match.replace('{}', '{' + map.join(',') +'}');
			});
			grunt.file.write(config.src, content);
		}
		return;
	});

};